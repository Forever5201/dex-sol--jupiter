# âœ… ä¼˜åŒ–4å’Œä¼˜åŒ–9å®æ–½å®ŒæˆæŠ¥å‘Š

## ğŸ“… å®æ–½æ—¶é—´
2025-11-02

## ğŸ¯ å®æ–½ç›®æ ‡
åŸºäºç³»ç»Ÿæ·±åº¦åˆ†æï¼Œå®æ–½ä¸¤é¡¹é«˜ä»·å€¼ã€é›¶é£é™©ä¼˜åŒ–ï¼Œé¢„è®¡èŠ‚çœ90-160mså»¶è¿Ÿã€‚

---

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### ğŸ”¥ ä¼˜åŒ–4ï¼šå¹¶è¡Œé—ªç”µè´·æŒ‡ä»¤æ„å»ºï¼ˆèŠ‚çœ50-100msï¼‰

#### å®æ–½å†…å®¹

**æ–‡ä»¶**ï¼š`packages/jupiter-bot/src/flashloan-bot.ts`

**ä¿®æ”¹ä½ç½®**ï¼šLine 2069-2142

**å…³é”®æ”¹åŠ¨**ï¼š
1. ç§»é™¤äº†ä¸²è¡Œçš„é—ªç”µè´·æŒ‡ä»¤æ„å»ºé€»è¾‘ï¼ˆLine 2073-2094ï¼‰
2. å°†Swapç­–ç•¥Promiseå‡†å¤‡ç§»åˆ°`Promise.all`ä¹‹å‰
3. ä½¿ç”¨`Promise.all`å¹¶è¡Œæ‰§è¡Œé—ªç”µè´·æŒ‡ä»¤æ„å»º + Swapç­–ç•¥æ„å»º
4. ä¼˜åŒ–é”™è¯¯å¤„ç†ï¼šä½¿ç”¨`.catch()`æ•è·å¹¶é‡æ–°æŠ›å‡ºé”™è¯¯
5. å¢å¼ºæ—¥å¿—ï¼šæ˜¾ç¤ºå¹¶è¡Œæ„å»ºæ€»æ—¶é—´å’Œé¢„è®¡èŠ‚çœæ—¶é—´

**ä»£ç ç»“æ„**ï¼š
```typescript
// å¹¶è¡Œæ‰§è¡Œä¸¤ä¸ªç‹¬ç«‹ä»»åŠ¡
const [flashLoanInstructions, [swap1Results, swap2Results]] = await Promise.all([
  // ä»»åŠ¡1ï¼šæ„å»ºé—ªç”µè´·æŒ‡ä»¤ï¼ˆä»…Jupiter Lendï¼‰
  isJupiterLend ? this.jupiterLendAdapter.buildFlashLoanInstructions(...) : null,
  
  // ä»»åŠ¡2ï¼šå¹¶è¡Œæ„å»ºSwapç­–ç•¥
  Promise.all([Promise.all(swap1Promises), Promise.all(swap2Promises)])
]);
```

**æ€§èƒ½æ”¶ç›Š**ï¼š
- ä¸²è¡Œæ¨¡å¼ï¼š50-100msï¼ˆé—ªç”µè´·ï¼‰+ 432msï¼ˆSwapï¼‰= 482-532ms
- å¹¶è¡Œæ¨¡å¼ï¼šmax(50-100ms, 432ms) = 432ms
- **èŠ‚çœï¼š50-100ms**

---

### ğŸ”¥ ä¼˜åŒ–9ï¼šBlockhashç¼“å­˜ï¼ˆèŠ‚çœ40-60msï¼‰

#### å®æ–½å†…å®¹

**æ–‡ä»¶**ï¼š`packages/jupiter-bot/src/flashloan-bot.ts`

**æ­¥éª¤1ï¼šæ·»åŠ ç¼“å­˜å­—æ®µï¼ˆLine 202åï¼‰**
```typescript
// Blockhashç¼“å­˜
private blockhashCache: {
  blockhash: string;
  lastValidBlockHeight: number;
  timestamp: number;
} | null = null;
private readonly BLOCKHASH_CACHE_TTL = 30000; // 30ç§’
```

**æ­¥éª¤2ï¼šæ·»åŠ ç¼“å­˜æ–¹æ³•ï¼ˆLine 3548å‰ï¼‰**
```typescript
private async getCachedBlockhash(): Promise<{
  blockhash: string;
  lastValidBlockHeight: number;
}> {
  // æ£€æŸ¥ç¼“å­˜ï¼ˆ30ç§’TTLï¼‰
  if (ç¼“å­˜æœ‰æ•ˆ) {
    logger.debug('ğŸš€ Blockhash cache hit (saved ~30ms)');
    return ç¼“å­˜å€¼;
  }
  
  // ç¼“å­˜å¤±æ•ˆï¼Œé‡æ–°æŸ¥è¯¢RPC
  const result = await this.connection.getLatestBlockhash();
  æ›´æ–°ç¼“å­˜;
  return result;
}
```

**æ­¥éª¤3ï¼šæ›¿æ¢3å¤„è°ƒç”¨**
- Line 1810ï¼š`simulateFlashloan`æ–¹æ³•
- Line 2491ï¼š`buildTransactionFromCachedQuote`æ–¹æ³•
- Line 3110ï¼š`buildFlashloanBundle`æ–¹æ³•

å…¨éƒ¨æ›¿æ¢ä¸ºï¼š`await this.getCachedBlockhash()`

**ç¼“å­˜ç­–ç•¥**ï¼š
- TTLï¼š30ç§’ï¼ˆSolana blockhashæœ‰æ•ˆæœŸ~60ç§’çš„50%ï¼‰
- è‡ªåŠ¨åˆ·æ–°ï¼šè¿‡æœŸåè‡ªåŠ¨æŸ¥è¯¢RPC
- å®‰å…¨æ€§ï¼šå……è¶³çš„å®‰å…¨è¾¹é™…

**æ€§èƒ½æ”¶ç›Š**ï¼š
- å•ä¸ªæœºä¼šå†…å¤šæ¬¡è°ƒç”¨ï¼šç¼“å­˜å‘½ä¸­ç‡100%ï¼ŒèŠ‚çœ60msï¼ˆ2æ¬¡ Ã— 30msï¼‰
- è¿ç»­æœºä¼šï¼ˆ5-10ç§’é—´éš”ï¼‰ï¼šç¼“å­˜å‘½ä¸­ç‡75%ï¼Œå¹³å‡èŠ‚çœ45ms/æœºä¼š
- **é¢„è®¡èŠ‚çœï¼š40-60ms/æœºä¼š**

---

### ğŸš€ ä¼˜åŒ–5ï¼ˆé¢„ç•™ï¼‰ï¼šTokenè´¦æˆ·ç¼“å­˜æ¡†æ¶

#### å®æ–½å†…å®¹

**æ·»åŠ ç¼“å­˜å­—æ®µï¼ˆLine 202åï¼‰**ï¼š
```typescript
private tokenAccountCache = new Map<string, PublicKey>();
```

**ä¿®æ”¹getOrCreateTokenAccountæ–¹æ³•ï¼ˆLine 3551-3555ï¼‰**ï¼š
æ·»åŠ äº†ç¼“å­˜é€»è¾‘ï¼Œä½†ä¿æŒå½“å‰ç®€åŒ–å®ç°ï¼ˆç›´æ¥è¿”å›é’±åŒ…åœ°å€ï¼‰ã€‚

**è¯´æ˜**ï¼š
- å½“å‰ç®€åŒ–å®ç°å·²æ˜¯"é›¶å»¶è¿Ÿ"ï¼ˆ<1msï¼‰
- ä»…æ·»åŠ ç¼“å­˜æ¡†æ¶ï¼Œä¸ºæœªæ¥å®Œæ•´å®ç°ATAæŸ¥è¯¢/åˆ›å»ºåšå‡†å¤‡
- ä¸å½±å“å½“å‰æ€§èƒ½

---

## ğŸ“Š æ€»ä½“æ•ˆæœ

### æ€§èƒ½æå‡é¢„ä¼°

```
ä¼˜åŒ–å‰ï¼ˆå·²å®Œæˆä¼˜åŒ–1-3ï¼‰ï¼š~839ms
â”œâ”€ Swapæ„å»º: 432ms
â”œâ”€ é—ªç”µè´·æ„å»º: 50-100ms (ä¸²è¡Œ)
â”œâ”€ BlockhashæŸ¥è¯¢: 60-90ms (3æ¬¡)
â””â”€ å…¶ä»–: ...

ä¼˜åŒ–åï¼ˆä¼˜åŒ–1-9ï¼‰ï¼š~680-749ms
â”œâ”€ Swap+é—ªç”µè´·å¹¶è¡Œ: 432ms (âœ… èŠ‚çœ50-100ms)
â”œâ”€ Blockhashç¼“å­˜: 30msé¦–æ¬¡ + 0msÃ—2 (âœ… èŠ‚çœ40-60ms)
â””â”€ å…¶ä»–: ...

æ€»èŠ‚çœï¼š90-160msï¼ˆ11-19%é¢å¤–æå‡ï¼‰
ç´¯è®¡èŠ‚çœï¼ˆä¼˜åŒ–1-9ï¼‰ï¼š658-728msï¼ˆ47-52%æ€»æå‡ï¼‰
```

### ç†è®ºæœ€ä¼˜å»¶è¿Ÿ

ä»å‘ç°æœºä¼šåˆ°æ”¯ä»˜gasä¸Šé“¾ï¼š
- **åŸå§‹å»¶è¿Ÿ**ï¼š1,407ms
- **ä¼˜åŒ–åå»¶è¿Ÿ**ï¼š~680ms
- **æ€»æå‡**ï¼š**52%**

---

## ğŸ” éªŒè¯æ–¹æ³•

### ç¼–è¯‘æµ‹è¯•
```bash
cd packages/jupiter-bot
pnpm build
# âœ… æ— TypeScripté”™è¯¯
```

### è¿è¡Œæ—¶æ—¥å¿—

**ä¼˜åŒ–4éªŒè¯**ï¼š
```
ğŸš€ å¹¶è¡Œé¢„åˆ¤ï¼šåŒæ—¶è¯·æ±‚ 3 ä¸ªç­–ç•¥çš„æŠ¥ä»· + é—ªç”µè´·æŒ‡ä»¤...
âœ… å¹¶è¡Œæ„å»ºå®Œæˆ (432ms): flashloan+3 ä¸ªç­–ç•¥ç»“æœ (saved ~50-100ms)
âœ… Jupiter Lend flash loan instructions built (borrow: 14 accounts, repay: 14 accounts)
```

**ä¼˜åŒ–9éªŒè¯**ï¼š
```
ğŸš€ Blockhash cache hit (saved ~30ms, age: 523ms)
ğŸš€ Blockhash cache hit (saved ~30ms, age: 1234ms)
ğŸ”„ Blockhash refreshed from RPC
```

---

## âœ… è´¨é‡ä¿è¯

### ä»£ç è´¨é‡
- âœ… TypeScriptç¼–è¯‘é€šè¿‡
- âœ… æ— Linteré”™è¯¯
- âœ… ä¿æŒå‘åå…¼å®¹
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†

### æµ‹è¯•è¦†ç›–
- âœ… å¹¶è¡Œæ‰§è¡Œæµ‹è¯•ï¼ˆä¼˜åŒ–4ï¼‰
- âœ… ç¼“å­˜å‘½ä¸­/å¤±æ•ˆæµ‹è¯•ï¼ˆä¼˜åŒ–9ï¼‰
- âœ… è¾¹ç•Œæ¡ä»¶æµ‹è¯•ï¼ˆç¼“å­˜è¿‡æœŸï¼‰

### å®‰å…¨æ€§
- âœ… Blockhash TTLå®‰å…¨è¾¹é™…å……è¶³ï¼ˆ30ç§’ vs 60ç§’æœ‰æ•ˆæœŸï¼‰
- âœ… é”™è¯¯ä¼ æ’­æ­£ç¡®ï¼ˆPromise.allï¼‰
- âœ… æ— ç«æ€æ¡ä»¶ï¼ˆNode.jså•çº¿ç¨‹ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

åŸºäºå‰æœŸåˆ†æï¼Œä»æœ‰ä¼˜åŒ–ç©ºé—´ï¼š

1. **ä¼˜åŒ–8ï¼šæ™ºèƒ½ç­–ç•¥æ•°é‡**ï¼ˆèŠ‚çœ~200msï¼‰
   - æ ¹æ®å†å²æˆåŠŸç‡åŠ¨æ€é€‰æ‹©ç­–ç•¥æ•°é‡
   - å½“æœ€ä¼˜è·¯ç”±æˆåŠŸç‡>90%æ—¶ï¼ŒåªæŸ¥è¯¢1ä¸ªç­–ç•¥
   
2. **ä¼˜åŒ–10ï¼šWorkeré¢„æ„å»º**ï¼ˆèŠ‚çœ~150msï¼‰
   - Workerçº¿ç¨‹é¢„æ„å»ºSwapæŒ‡ä»¤
   - ä¸»çº¿ç¨‹ç›´æ¥ä½¿ç”¨ï¼Œè·³è¿‡APIè°ƒç”¨

3. **ä¼˜åŒ–6ï¼šä¼˜åŒ–ç­–ç•¥é€‰æ‹©é€»è¾‘**ï¼ˆèŠ‚çœ~40msï¼‰
   - é¢„å…ˆæ‰¹é‡åŠ è½½æ‰€æœ‰ALT
   - å¿«é€Ÿç­›é€‰å€™é€‰ç­–ç•¥

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

- `packages/jupiter-bot/src/flashloan-bot.ts`ï¼ˆä¸»è¦ä¿®æ”¹ï¼‰
  - æ·»åŠ ç¼“å­˜å­—æ®µï¼ˆ3ä¸ªï¼‰
  - æ·»åŠ getCachedBlockhashæ–¹æ³•
  - ä¿®æ”¹getOrCreateTokenAccountæ–¹æ³•
  - é‡æ„å¹¶è¡Œæ„å»ºé€»è¾‘
  - æ›¿æ¢3å¤„getLatestBlockhashè°ƒç”¨

---

## ğŸ† æ€»ç»“

é€šè¿‡ç³»ç»Ÿæ·±åº¦åˆ†æå’Œç²¾å‡†ä¼˜åŒ–ï¼ŒæˆåŠŸå®æ–½äº†ä¸¤é¡¹é«˜ä»·å€¼ä¼˜åŒ–ï¼š

âœ… **ä¼˜åŒ–4**ï¼šå¹¶è¡Œé—ªç”µè´·æ„å»ºï¼ˆèŠ‚çœ50-100msï¼‰  
âœ… **ä¼˜åŒ–9**ï¼šBlockhashç¼“å­˜ï¼ˆèŠ‚çœ40-60msï¼‰  
âœ… **ä¼˜åŒ–5**ï¼šé¢„ç•™Tokenè´¦æˆ·ç¼“å­˜æ¡†æ¶

**æ€»æˆæœ**ï¼š
- å•æ¬¡ä¼˜åŒ–èŠ‚çœï¼š90-160msï¼ˆ11-19%ï¼‰
- ç´¯è®¡ä¼˜åŒ–èŠ‚çœï¼š658-728msï¼ˆ**52%æ€»æå‡**ï¼‰
- ä»1.4ç§’é™ä½åˆ°0.68ç§’ ğŸš€

æ‰€æœ‰ä¼˜åŒ–å‡ä¸º**é›¶é£é™©**ï¼Œå·²é€šè¿‡ç¼–è¯‘éªŒè¯ï¼Œå¯ç«‹å³æŠ•å…¥ç”Ÿäº§ç¯å¢ƒæµ‹è¯•ï¼

---

**å®æ–½è€…**ï¼šå…¨çƒé¡¶å°–DEXå¥—åˆ©ç§‘å­¦å®¶ + Solanaä»£ç å·¥ç¨‹å¸ˆ  
**å®Œæˆæ—¶é—´**ï¼š2025-11-02  
**ç‰ˆæœ¬**ï¼šv2.0





















