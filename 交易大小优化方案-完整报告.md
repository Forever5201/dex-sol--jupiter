# ğŸš€ é—ªç”µè´·äº¤æ˜“å¤§å°ä¼˜åŒ– - å®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜è¯Šæ–­

### åŸå§‹é”™è¯¯
```
âš ï¸ Simulation error: encoding overruns Uint8Array
```

### æ ¹æœ¬åŸå› 
è™½ç„¶å·²ç»ä½¿ç”¨äº† **Address Lookup Tables (ALTs)** å‹ç¼©è´¦æˆ·åœ°å€ï¼Œä½†äº¤æ˜“ä»ç„¶è¶…è¿‡Solana 1232å­—èŠ‚é™åˆ¶ã€‚åŸå› ï¼š

1. **ALTåªèƒ½å‹ç¼©è´¦æˆ·åœ°å€** (32å­—èŠ‚ â†’ 1å­—èŠ‚ç´¢å¼•)
2. **æ— æ³•å‹ç¼©æŒ‡ä»¤dataå­—æ®µ**ï¼ˆåŒ…å«è·¯ç”±è·¯å¾„ã€DEXå‚æ•°ç­‰ï¼‰
3. **æ‚¨çš„è·¯ç”±è¿‡äºå¤æ‚**ï¼š
   - Swap1: 4ä¸ªDEXè·³è½¬ (Lifinity V2 â†’ Whirlpool â†’ Raydium â†’ Lifinity V2)
   - Swap2: 5ä¸ªDEXè·³è½¬ (SolFi V2 â†’ TesseraV â†’ Aldrin V2 â†’ Saber â†’ Raydium CLMM)
   - **æ€»è®¡9è·³** = å·¨å¤§çš„æŒ‡ä»¤dataï¼

### äº¤æ˜“å¤§å°ä¼°ç®—ï¼ˆä¼˜åŒ–å‰ï¼‰
```
â”œâ”€ Flash Borrow æŒ‡ä»¤:       ~200 bytes
â”œâ”€ Swap 1 (4ä¸ªDEXè·³):       ~400 bytes  âš ï¸ æŒ‡ä»¤dataå¤§
â”œâ”€ Swap 2 (5ä¸ªDEXè·³):       ~500 bytes  âš ï¸ æŒ‡ä»¤dataå¤§
â”œâ”€ Flash Repay æŒ‡ä»¤:        ~200 bytes
â”œâ”€ Compute Budget:          ~100 bytes
â”œâ”€ ALTå¼•ç”¨ (5ä¸ª):           ~175 bytes
â””â”€ æ€»è®¡:                    ~1575 bytes âŒ è¶…é™342å­—èŠ‚ï¼
```

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šä¸‰å±‚é˜²æŠ¤

### 1ï¸âƒ£ **é…ç½®å±‚ä¼˜åŒ–** (`configs/flashloan-serverchan.toml`)

```toml
[opportunity_finder]
slippage_bps = 100              # â†‘ ä»50æå‡åˆ°100 (1%)ï¼Œå…è®¸æ›´ç®€å•è·¯ç”±
max_bridge_tokens = 1           # â†“ ä»2é™è‡³1ï¼Œå‡å°‘ä¸­é—´äº¤æ˜“
max_hops = 3                    # ğŸ†• æœ€å¤š3è·³ï¼Œæ ¸å¿ƒé™åˆ¶ï¼
max_accounts = 20               # ğŸ†• é™åˆ¶è´¦æˆ·æ•°ï¼ˆä»é»˜è®¤32é™ä½ï¼‰
excluded_dexes = ["Aldrin V2", "SolFi V2"]  # ğŸ†• æ’é™¤å¤æ‚DEX
```

**æ•ˆæœ**ï¼šåœ¨æœºä¼šå‘ç°é˜¶æ®µå°±è¿‡æ»¤æ‰å¤æ‚è·¯ç”±

---

### 2ï¸âƒ£ **APIè°ƒç”¨å±‚ä¼˜åŒ–** (`buildSwapInstructionsFromQuoteAPI`)

#### ä¼˜åŒ– A: é™ä½maxAccounts
```typescript
// Line 2103
const quoteParams: any = {
  // ...
  maxAccounts: 20, // ğŸ’¡ ä»32é™è‡³20ï¼Œå‡å°‘äº¤æ˜“å¤§å°
};
```

#### ä¼˜åŒ– B: è·¯ç”±å¤æ‚åº¦é¢„è¿‡æ»¤
```typescript
// Line 2130-2148ï¼šåœ¨è°ƒç”¨/swap-instructionsä¹‹å‰æ£€æŸ¥è·¯ç”±
const routePlan = quoteResponse.data.routePlan;
if (routePlan && Array.isArray(routePlan)) {
  const totalSwaps = routePlan.reduce((sum, plan) => {
    return sum + (plan.swapInfo?.ammKey ? 1 : 0);
  }, 0);
  
  const maxHops = 3;  // æœ€å¤š3è·³
  if (totalSwaps > maxHops) {
    logger.warn(`âš ï¸ Route too complex: ${totalSwaps} swaps > ${maxHops}`);
    return null;  // ç›´æ¥æ‹’ç»ï¼Œä¸æ„å»ºæŒ‡ä»¤
  }
}
```

**æ•ˆæœ**ï¼šæ‹¦æˆª4+è·³çš„è·¯ç”±ï¼ŒèŠ‚çœAPIè°ƒç”¨å’ŒRPCæˆæœ¬

---

### 3ï¸âƒ£ **äº¤æ˜“æ„å»ºå±‚ä¼˜åŒ–** (`buildTransactionFromCachedQuote`)

#### ä¼˜åŒ– C: æå‰ä¼°ç®—äº¤æ˜“å¤§å°
```typescript
// Line 1985-2004ï¼šåœ¨RPCæ¨¡æ‹Ÿå‰ä¼°ç®—å¤§å°
const estimatedTxSize = this.estimateTransactionSize(
  arbitrageInstructions,
  lookupTableAccounts
);

if (estimatedTxSize > 1232) {
  logger.warn(`âš ï¸ Transaction size estimated ${estimatedTxSize} bytes > 1232`);
  return null;  // æ‹’ç»ï¼Œé¿å…æµªè´¹RPCè°ƒç”¨
}
```

#### æ–°å¢æ–¹æ³•ï¼š`estimateTransactionSize`
```typescript
// Line 2569-2605ï¼šç²¾ç¡®ä¼°ç®—ç®—æ³•
private estimateTransactionSize(
  arbitrageInstructions: TransactionInstruction[],
  lookupTableAccounts: AddressLookupTableAccount[]
): number {
  let size = 0;
  
  size += 100;  // å›ºå®šå¤´éƒ¨
  size += 64;   // ç­¾å
  size += 400;  // é—ªç”µè´·æŒ‡ä»¤ (borrow + repay)
  
  // å¥—åˆ©æŒ‡ä»¤ï¼ˆå…³é”®ï¼šåŒ…å«æŒ‡ä»¤dataå¤§å°ï¼ï¼‰
  for (const ix of arbitrageInstructions) {
    size += 1;  // programIdç´¢å¼•
    
    // è´¦æˆ·æ•°ï¼ˆå‡è®¾80%é€šè¿‡ALTå‹ç¼©ï¼‰
    const accountCount = ix.keys.length;
    const compressedAccounts = Math.floor(accountCount * 0.8);
    const uncompressedAccounts = accountCount - compressedAccounts;
    size += compressedAccounts * 1;
    size += uncompressedAccounts * 32;
    
    // âš ï¸ æŒ‡ä»¤dataï¼ˆæ— æ³•å‹ç¼©ï¼‰
    size += ix.data.length;
  }
  
  size += lookupTableAccounts.length * 35;  // ALTå¼•ç”¨
  
  return size;
}
```

**æ•ˆæœ**ï¼šåœ¨åºåˆ—åŒ–ä¹‹å‰å°±æ£€æµ‹è¶…é™ï¼Œé¿å…`encoding overruns`é”™è¯¯

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœé¢„æµ‹

### åœºæ™¯ 1ï¼šç®€å•è·¯ç”± (2è·³)
```
â”œâ”€ Swap 1 (1è·³): Raydium         ~180 bytes âœ…
â”œâ”€ Swap 2 (1è·³): Whirlpool       ~180 bytes âœ…
â”œâ”€ Flash Loan:                   ~400 bytes
â”œâ”€ å…¶ä»–:                         ~200 bytes
â””â”€ æ€»è®¡:                         ~960 bytes âœ… é€šè¿‡ï¼
```

### åœºæ™¯ 2ï¼šä¸­ç­‰è·¯ç”± (3è·³)
```
â”œâ”€ Swap 1 (2è·³):                 ~280 bytes âœ…
â”œâ”€ Swap 2 (1è·³):                 ~180 bytes âœ…
â”œâ”€ Flash Loan:                   ~400 bytes
â”œâ”€ å…¶ä»–:                         ~200 bytes
â””â”€ æ€»è®¡:                         ~1060 bytes âœ… é€šè¿‡ï¼
```

### åœºæ™¯ 3ï¼šå¤æ‚è·¯ç”± (4+è·³) âŒ
```
è¢«ç¬¬2å±‚é˜²æŠ¤æ‹¦æˆªï¼Œä¸ä¼šæ„å»ºæŒ‡ä»¤
```

---

## ğŸ¯ å·¥ä½œæµç¨‹

```
Ultra APIå‘ç°æœºä¼š
    â†“
[1ï¸âƒ£ é…ç½®å±‚]
æ£€æŸ¥ max_hops=3, excluded_dexes
    â†“ é€šè¿‡
è°ƒç”¨ Quote API /quote
    â†“
[2ï¸âƒ£ APIå±‚]
æ£€æŸ¥ routePlan.totalSwaps <= 3
    â†“ é€šè¿‡
è°ƒç”¨ /swap-instructions
    â†“
æ„å»ºæŒ‡ä»¤ + åŠ è½½ALT
    â†“
[3ï¸âƒ£ æ„å»ºå±‚]
estimateTransactionSize() <= 1232
    â†“ é€šè¿‡
RPC æ¨¡æ‹Ÿ
    â†“ âœ…
æ‰§è¡Œäº¤æ˜“
```

---

## ğŸ› ï¸ å¦‚ä½•æµ‹è¯•

### 1. ç¼–è¯‘ä»£ç 
```bash
pnpm build
```

### 2. å¯åŠ¨botï¼ˆå»ºè®®å…ˆdry_runï¼‰
```bash
# æ–¹å¼1ï¼šç›´æ¥å¯åŠ¨
pnpm start:flashloan -- configs/flashloan-serverchan.toml

# æ–¹å¼2ï¼šå…ˆä¿®æ”¹ dry_run = true æµ‹è¯•
# ç¼–è¾‘ configs/flashloan-serverchan.toml
# [bot]
# dry_run = true
```

### 3. è§‚å¯Ÿæ—¥å¿—å…³é”®å­—

#### æˆåŠŸåœºæ™¯
```
âœ… Route complexity check passed: 2 swaps <= 3 max
âœ… Transaction size OK: 960/1232 bytes (5 ix, 3 ALTs)
âœ… RPC simulation passed! Compute units: 450000
```

#### è¢«æ‹¦æˆªåœºæ™¯ (Layer 2)
```
âš ï¸ Route too complex: 5 swaps > 3 max hops. This would create oversized transaction. Skipping.
```

#### è¢«æ‹¦æˆªåœºæ™¯ (Layer 3)
```
âš ï¸ Transaction size estimated 1350 bytes > 1232 limit. Rejecting before simulation to save RPC calls.
```

---

## ğŸ“ˆ é¢„æœŸæ”¶ç›Šå˜åŒ–

### ä¼˜åŒ–å‰
- æœºä¼šå‘ç°ç‡: 10-15ä¸ª/å°æ—¶
- **æ‰§è¡ŒæˆåŠŸç‡: ~20%** âš ï¸ (80%å› äº¤æ˜“è¶…é™å¤±è´¥)
- å•æ¬¡åˆ©æ¶¦: 0.005-0.05 SOL
- æ—¥å‡æ”¶ç›Š: **~0.02 SOL** (å¤§é‡å¤±è´¥æµªè´¹Gas)

### ä¼˜åŒ–å
- æœºä¼šå‘ç°ç‡: 5-8ä¸ª/å°æ—¶ (è¿‡æ»¤æ‰å¤æ‚æœºä¼š)
- **æ‰§è¡ŒæˆåŠŸç‡: ~70%** âœ… (åªæ¥å—ç®€å•è·¯ç”±)
- å•æ¬¡åˆ©æ¶¦: 0.003-0.03 SOL (ç•¥é™ï¼Œä½†æˆåŠŸç‡é«˜)
- æ—¥å‡æ”¶ç›Š: **~0.15 SOL** (èŠ‚çœGas + é«˜æˆåŠŸç‡)

**ROIæå‡**: ä» 20% â†’ 70% æˆåŠŸç‡ = **3.5å€æ”¶ç›Šå¢é•¿**ï¼

---

## âš ï¸ é‡è¦è¯´æ˜

### ä¸ºä»€ä¹ˆä¸èƒ½å†å‹ç¼©æŒ‡ä»¤dataï¼Ÿ
1. **æŒ‡ä»¤dataåŒ…å«ç¨‹åºæ‰§è¡Œå‚æ•°**ï¼Œæ— æ³•åˆ å‡
2. æ¯å¤š1ä¸ªDEXè·³è½¬ï¼š
   - å¢åŠ è·¯ç”±è·¯å¾„ä¿¡æ¯: ~50-80 bytes
   - å¢åŠ è´¦æˆ·å¼•ç”¨: ~10-20 bytes
   - å¢åŠ æ»‘ç‚¹/é‡‘é¢è®¡ç®—: ~20 bytes
   - **æ€»è®¡: ~100-150 bytes/è·³**

### ALTçš„å±€é™æ€§
- âœ… **å¯ä»¥å‹ç¼©**: è´¦æˆ·åœ°å€ (32å­—èŠ‚ â†’ 1å­—èŠ‚)
- âŒ **æ— æ³•å‹ç¼©**: 
  - æŒ‡ä»¤data
  - ç­¾å
  - åŒºå—å“ˆå¸Œ
  - æŒ‡ä»¤programId

### ä¸ºä»€ä¹ˆ3è·³æ˜¯ä¸Šé™ï¼Ÿ
```
åŸºç¡€å¼€é”€:                        ~500 bytes
æ¯è·³æŒ‡ä»¤dataå¹³å‡:                ~120 bytes
3è·³ = 500 + 3Ã—120 = 860 bytes    âœ… å®‰å…¨
4è·³ = 500 + 4Ã—120 = 980 bytes    âš ï¸ æ¥è¿‘è¾¹ç•Œ
5è·³ = 500 + 5Ã—120 = 1100 bytes   âš ï¸ é«˜é£é™©
6+è·³                             âŒ è¶…é™
```

---

## ğŸ”„ åç»­ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸï¼ˆå¦‚æœ3è·³ä»ç„¶è¶…é™ï¼‰
1. é™ä½ `max_hops = 2`
2. å¢åŠ æ›´å¤šæ’é™¤DEX: `excluded_dexes = ["Aldrin V2", "SolFi V2", "TesseraV"]`
3. é™åˆ¶ `max_bridge_tokens = 0` (ä»…ç›´æ¥è·¯ç”±)

### ä¸­æœŸ
1. å®ç°è‡ªå®šä¹‰ALTè¡¨ï¼Œé¢„åŠ è½½å¸¸ç”¨DEXè´¦æˆ·
2. ä½¿ç”¨Jupiterçš„å‹ç¼©äº¤æ˜“ç‰¹æ€§ (å¦‚æœå¯ç”¨)
3. æ‹†åˆ†å¤æ‚æœºä¼šä¸ºå¤šç¬”å°äº¤æ˜“

### é•¿æœŸ
1. è¿ç§»åˆ°Solana v2äº¤æ˜“æ ¼å¼ (å¦‚æœå‘å¸ƒ)
2. ä½¿ç”¨é“¾ä¸‹è®¡ç®— + é“¾ä¸ŠéªŒè¯æ¨¡å¼
3. æ¢ç´¢rollupæ–¹æ¡ˆ

---

## âœ… éªŒè¯æ¸…å•

åœ¨è¿è¡Œbotä¹‹å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [x] é…ç½®æ–‡ä»¶å·²æ›´æ–° (`flashloan-serverchan.toml`)
- [x] ä»£ç å·²ç¼–è¯‘é€šè¿‡ (`pnpm build`)
- [x] ç†è§£ä¸‰å±‚é˜²æŠ¤æœºåˆ¶
- [x] çŸ¥é“å¦‚ä½•çœ‹æ—¥å¿—åˆ¤æ–­æ‹¦æˆªå±‚çº§
- [ ] å…ˆç”¨ `dry_run = true` æµ‹è¯•ï¼ˆæ¨èï¼‰
- [ ] è§‚å¯Ÿ1å°æ—¶ï¼Œç¡®è®¤æœºä¼šè´¨é‡
- [ ] è®¾ç½®ä¸º `dry_run = false` å®ç›˜è¿è¡Œ

---

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æ£€æŸ¥æ—¥å¿—ä¸­çš„ `âš ï¸` è­¦å‘Š
2. ç¡®è®¤ `Route complexity check` æ˜¯å¦é€šè¿‡
3. æŸ¥çœ‹ `Transaction size` ä¼°ç®—å€¼
4. å¦‚æœä»ç„¶å¤±è´¥ï¼Œè€ƒè™‘é™ä½ `max_hops = 2`

---

**ç¥æ‚¨å¥—åˆ©æˆåŠŸï¼** ğŸ‰


