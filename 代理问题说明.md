# 🌐 代理配置问题说明

## 核心问题

**Node.js 不会自动读取 Windows 系统代理！**

### 检测结果
```
HTTP_PROXY: (空)
HTTPS_PROXY: (空)
```

---

## 📖 技术解释

### Windows 系统代理 ≠ Node.js 代理

| 配置方式 | 应用范围 | Node.js 能否读取 |
|---------|---------|-----------------|
| Windows 系统设置 → 代理 | 浏览器、系统应用 | ❌ **不能** |
| 环境变量 HTTP_PROXY | 命令行工具、Node.js | ✅ **能** |
| Clash/V2Ray 系统代理 | 浏览器、系统应用 | ❌ **不能** |

**关键点**:
- 即使您在 Windows 设置中配置了代理
- 即使 Clash/V2Ray 开启了"系统代理"
- **Node.js 仍然看不到这些配置！**

Node.js 只会读取**环境变量**:
```bash
HTTP_PROXY=http://127.0.0.1:7890
HTTPS_PROXY=http://127.0.0.1:7890
```

---

## ✅ 解决方案

### 方案 1: 永久设置环境变量（推荐）

打开 PowerShell（管理员），运行：

```powershell
# 假设您使用 Clash (端口 7890)
[System.Environment]::SetEnvironmentVariable('HTTP_PROXY', 'http://127.0.0.1:7890', 'User')
[System.Environment]::SetEnvironmentVariable('HTTPS_PROXY', 'http://127.0.0.1:7890', 'User')
```

**常见代理端口**:
- Clash: `7890`
- V2RayN: `10808`
- Shadowsocks: `1080`

**生效方式**: 重新打开终端

---

### 方案 2: 临时设置（当前会话）

在运行机器人前，先设置环境变量：

```batch
set HTTP_PROXY=http://127.0.0.1:7890
set HTTPS_PROXY=http://127.0.0.1:7890
start-flashloan-dryrun.bat
```

---

### 方案 3: 修改代码自动读取系统代理（高级）

我可以修改 `NetworkAdapter` 让它自动读取 Windows 系统代理设置。

---

## 🔧 如何检测您的代理配置

### 1. 检查 Clash/V2Ray 端口

打开 Clash/V2Ray 设置，查看 "HTTP 代理端口"

### 2. 检查 Windows 系统代理

```
Windows 设置 → 网络和Internet → 代理
```

如果显示：
```
代理服务器: 127.0.0.1:7890
```

那么您应该设置：
```
HTTP_PROXY=http://127.0.0.1:7890
```

### 3. 运行检测脚本

```batch
detect-system-proxy.bat
```

---

## 🎯 为什么之前的脚本要设置代理？

因为代码从 `process.env.HTTP_PROXY` 读取代理配置：

```typescript
// packages/core/src/network/unified-adapter.ts
private loadConfig(): NetworkAdapterConfig {
  const config: NetworkAdapterConfig = {
    httpProxy: process.env.HTTP_PROXY || process.env.http_proxy,  // ← 从这里读取
    httpsProxy: process.env.HTTPS_PROXY || process.env.https_proxy,
    // ...
  };
  return config;
}
```

如果环境变量是空的，代码就无法使用代理！

---

## 📊 您的选择

### 选项 A: 我来永久设置环境变量（推荐）

**优点**: 一次设置，永久有效  
**缺点**: 需要知道代理端口

**操作**:
1. 确认代理端口（Clash: 7890, V2Ray: 10808）
2. 运行 PowerShell 命令设置环境变量
3. 重启终端
4. 直接运行 `start-flashloan-dryrun.bat`

---

### 选项 B: 每次临时设置（简单）

**优点**: 不需要永久修改  
**缺点**: 每次启动都要设置

**操作**:
使用我之前给您的脚本 `启动测试 - 使用代理.bat`，它会自动设置临时环境变量

---

### 选项 C: 修改代码自动读取系统代理（最智能）

**优点**: 完全自动化，无需手动配置  
**缺点**: 需要修改代码

**我可以帮您实现**:
- 添加 Windows 系统代理自动检测
- 如果环境变量为空，自动读取系统代理
- 无需任何手动配置

---

## 💡 建议

**最简单的做法**:

1. **现在立即测试**: 使用 `启动测试 - 使用代理.bat` 
   - 编辑文件，改成您的代理端口
   - 运行测试

2. **长期使用**: 永久设置环境变量
   ```powershell
   [System.Environment]::SetEnvironmentVariable('HTTP_PROXY', 'http://127.0.0.1:7890', 'User')
   [System.Environment]::SetEnvironmentVariable('HTTPS_PROXY', 'http://127.0.0.1:7890', 'User')
   ```

3. **终极方案**: 让我修改代码自动检测系统代理
   - 您什么都不用做
   - 代码自动适配

---

## ❓ 您想要哪种方案？

请告诉我：
1. **您使用的代理软件**: [ ] Clash / [ ] V2Ray / [ ] Shadowsocks / [ ] 其他
2. **代理端口**: _______
3. **您希望**: 
   - [ ] 我自己设置环境变量
   - [ ] 使用启动脚本设置（临时）
   - [ ] 让您修改代码自动检测（最智能）

我会根据您的选择提供最合适的解决方案！





